@page "/login"
@using Farma.FarmaciaApp.Services
@using MudBlazor
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject PharmacyAuthState AuthState

<MudGrid Class="login-wrapper" Justify="Justify.Center" AlignItems="AlignItems.Center">
    <MudItem xs="12" sm="8" md="5" lg="4">
        <MudPaper Elevation="0" Class="pa-8 surface-card login-card">
            <MudStack Spacing="5">
                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                    <MudAvatar Size="Size.Large" Class="credential-avatar">
                        <MudIcon Icon="@Icons.Material.Filled.LocalPharmacy" Size="Size.Large" />
                    </MudAvatar>

                    <MudText Typo="Typo.h3" Class="text-accent">
                        RappiFarma
                    </MudText>

                    <MudChip Color="Color.Primary" Variant="Variant.Filled" Class="credential-chip" StartIcon="@Icons.Material.Filled.BusinessCenter">
                        Portal para farmacias
                    </MudChip>

                    <MudText Typo="Typo.body1" Class="text-center text-muted">
                        Gestioná pedidos de medicamentos de manera eficiente
                    </MudText>
                </MudStack>

                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                    Para la demo podés usar <strong>farmacia.central / central2025</strong> o cualquiera de las farmacias registradas.
                </MudAlert>

                <MudForm @ref="_form" Model="_model">
                    <MudStack Spacing="4">
                        <MudTextField @bind-Value="_model.Codigo"
                                      Label="ID de farmacia"
                                      Placeholder="farmacia.central"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Store" />

                        <MudTextField @bind-Value="_model.Password"
                                      Label="Contraseña"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Lock" />

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Disabled="_isSubmitting"
                                   FullWidth="true"
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Login"
                                   OnClick="HandleLoginAsync"
                                   Class="mt-4"
                                   Style="height: 56px; border-radius: 16px; font-weight: 600;">
                            @if (_isSubmitting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span style="margin-left: 8px;">Ingresando...</span>
                            }
                            else
                            {
                                <span>Ingresar al portal</span>
                            }
                        </MudButton>
                    </MudStack>
                </MudForm>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private readonly LoginModel _model = new();
    private MudForm? _form;
    private bool _isSubmitting;
    private string? _returnUrl;

    protected override void OnInitialized()
    {
        if (AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("/pedidos/disponibles", replace: true);
            return;
        }

        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (!string.IsNullOrEmpty(uri.Query))
        {
            var segments = uri.Query.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries);
            foreach (var segment in segments)
            {
                var kv = segment.Split('=', 2, StringSplitOptions.RemoveEmptyEntries);
                if (kv.Length > 0 && string.Equals(kv[0], "returnUrl", StringComparison.OrdinalIgnoreCase))
                {
                    _returnUrl = kv.Length > 1 ? Uri.UnescapeDataString(kv[1]) : null;
                    break;
                }
            }
        }
    }

    private async Task HandleLoginAsync()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }

        _isSubmitting = true;
        var success = await AuthState.LoginAsync(_model.Codigo, _model.Password);
        _isSubmitting = false;

        if (!success)
        {
            Snackbar.Add("Credenciales inválidas. Revisá el ID y la contraseña provistos.", Severity.Error);
            return;
        }

        Snackbar.Add("Sesión iniciada.", Severity.Success);
        var destination = string.IsNullOrWhiteSpace(_returnUrl) ? "/pedidos/disponibles" : _returnUrl!;
        Navigation.NavigateTo(destination.StartsWith("/") ? destination : $"/{destination}", replace: true);
    }

    private class LoginModel
    {
        public string Codigo { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}

